nameOverride: ml
fullnameOverride: ml

image:
  repository: ghcr.io/immich-app/immich-machine-learning
  tag: "latest"

service:
  ports:
  - port: 3003
    name: http

env:
- name: IMMICH_PORT
  value: "3003"
- name: MPLCONFIGDIR
  value: "/cache/matplotlib"
- name: HF_XET_CACHE
  value: "/cache/huggingface-xet"

livenessProbe:
  httpGet:
    path: /ping
    port: 3003
  initialDelaySeconds: 100
  periodSeconds: 500
readinessProbe:
  httpGet:
    path: /ping
    port: 3003
  initialDelaySeconds: 10
  periodSeconds: 10
resources:
  limits:
    cpu: "3.5"
    memory: 3328Mi
  requests:
    cpu: 50m
    memory: 512Mi

volumeMounts:
- name: ml-cache
  mountPath: "/cache"
- name: tmp
  mountPath: "/tmp"
  
volumes:
- name: ml-cache
  persistentVolumeClaim:
    claimName: ml-cache
- name: tmp
  emptyDir:
    sizeLimit: 50Gi

persistentVolumeClaimData:
- name: ml-cache
  accessmode: ReadWriteOncePod
  request: 50Gi
  annotations:
    argocd.argoproj.io/sync-options: "Prune=false"

terminationGracePeriodSeconds: 15

podSecurityContext:
  runAsUser: 50006
  runAsGroup: 50006
  fsGroup: 50006

affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: node.io/role
            operator: In
            values:
            - core
